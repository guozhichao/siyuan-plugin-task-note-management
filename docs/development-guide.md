# 思源笔记插件开发调试指南

本文档详细介绍了思源笔记插件的开发环境配置、调试技巧和最佳实践。

## 环境配置

### 1. 基础环境要求

- **Node.js**: 版本 >= 16.0.0
- **npm**: 版本 >= 8.0.0
- **思源笔记**: 最新版本
- **操作系统**: Windows/macOS/Linux

### 2. 项目依赖安装

```bash
# 安装项目依赖
npm install
```

### 3. 插件目录配置

#### 修改脚本中的 targetDir 参数

直接在开发脚本中指定思源笔记插件目录路径：

1. **编辑 `scripts/make_dev_link.js` 文件**：
   ```javascript
   // 找到第 13 行左右的 targetDir 变量
   let targetDir = 'D:\\siyuan\\data\\plugins';
   ```

2. **编辑 `scripts/make_dev_copy.js` 文件**：
   ```javascript
   // 找到第 13 行左右的 targetDir 变量
   let targetDir = 'D:\\siyuan\\data\\plugins';
   ```

## 开发流程

### 1. 开发模式选择

项目提供两种开发模式：

#### 方式一：自动拷贝模式（推荐）

```bash
# 直接启动开发模式（自动拷贝到思源插件目录）
npm run dev
```

**工作流程：**
```
源代码修改 (src/) 
    ↓ (npm run dev 自动监听并构建)
构建输出 (dev/)
    ↓ (自动拷贝)
思源插件目录
    ↓
思源笔记需要手动重启插件
```

#### 方式二：符号链接模式

```bash
# 1. 创建开发链接（只需运行一次）
npm run make-link-win    # Windows
npm run make-link        # macOS/Linux

# 2. 启动符号链接开发模式（禁用自动拷贝）
npm run dev:link
```

**工作流程：**
```
源代码修改 (src/) 
    ↓ (npm run dev:link 自动监听并构建)
构建输出 (dev/)
    ↓ (符号链接)
思源插件目录 (SiYuan/plugins/插件名/)
    ↓
思源笔记自动重新加载
```

**符号链接模式说明：**

- **工作原理**：该模式会将项目的 `dev` 目录创建软链接到思源笔记插件目录
- **文件同步**：由于是符号链接，`dev` 目录中的文件变化会实时反映到思源插件目录
- **重要提醒**：这种方式**不参与同步**,自动拷贝模式会通过思源的同步功能直接同步至其他设备
- **适用场景**：适合频繁修改调试，享受真正的热重载体验
- **权限要求**：Windows 系统需要管理员权限才能创建符号链接

### 2. 构建命令说明

| 命令 | 功能 | 使用场景 |
|------|------|----------|
| `npm run dev` | 开发模式，自动拷贝到插件目录 | 快速开始开发 |
| `npm run dev:link` | 符号链接开发模式，禁用自动拷贝 | 配合符号链接使用 |
| `npm run build` | 生产构建 | 发布前构建 |
| `npm run make-link-win` | 创建开发链接（Windows） | 初始化符号链接环境 |
| `npm run make-link` | 创建开发链接（其他系统） | 初始化符号链接环境 |
| `npm run make-install` | 构建并安装到思源 | 测试完整安装流程 |

### 快速重启方法

#### 方法一：开发者工具刷新（推荐）

1. 在思源笔记中按 `F12` 打开开发者工具
2. 使用快捷键：
   - `F5` 或 `Ctrl + R` - 普通刷新
   - `Ctrl + Shift + R` - 强制刷新（清除缓存）

#### 方法二：插件管理重启

1. 思源笔记 → 设置 → 集市 → 已下载 → 插件
2. 找到对应插件，点击「禁用」
3. 再次点击「启用」

#### 方法三：重启开发模式

```bash
# 停止开发模式
Ctrl + C

# 重新启动
npm run dev
```

## 常见问题

### 1. 代码修改不生效

**问题**：修改代码后插件没有更新

**排查步骤**：
1. 检查 `npm run dev` 是否正在运行
2. 检查终端是否有构建错误信息
3. 检查 `dev` 目录是否有更新的文件
4. 打开思源笔记开发者工具，然后点击开发者工具窗口，然后按 `F5` 或者`ctrl+r`刷新页面
5. 如果还不行，重启插件或思源笔记
